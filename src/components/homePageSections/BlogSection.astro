---
import { Button } from "@/components/interactive/ui/button";
import Heading from "@/components/common/Heading.astro";
import NeuralLine from "@/components/background_animation/NeuralLine.astro";
import BlogCard from "@/components/cards/BlogCard.astro";
import { client } from "@/lib/sanity";
import { urlFor } from "@/lib/image";
import type { IBlogPost } from "@/utils/types";

// Fetch top 3 blogs from Sanity
let posts: IBlogPost[] = [];
try {
  posts = await client.fetch<IBlogPost[]>(
    `*[_type == "blog"] | order(_createdAt desc)[0...3] {
    "id": slug.current,
    title,
    "excerpt": coalesce(excerpt, array::join(string::split(pt::text(body), "")[0..150], "") + "..."),
    author, 
    _createdAt,
    category, 
    mainImage,
    image,
    readTime
  }`,
  );
} catch (error) {
  console.error("Error fetching blogs:", error);
}

// Function to format date
const formatDate = (dateString: string) => {
  if (!dateString) return "";
  return new Date(dateString).toLocaleDateString("en-US", {
    year: "numeric",
    month: "long",
    day: "numeric",
  });
};
---

<!-- Blog Section -->
<section id="blog" class="py-10 sm:py-20 relative overflow-hidden">
  <!-- Background Elements -->
  <div class="container mx-auto relative z-10 flex flex-col gap-8 sm:gap-16">
    <!-- Header -->
    <Heading
      section="Latest Insights"
      title="AI"
      highlights="Knowledge Hub"
      subtitle="Stay updated with the latest trends, insights, and innovations in artificial intelligence and machine learning."
    />

    <div class="flex flex-col gap-8 sm:gap-12">
      <!-- Blog Posts Grid -->
      <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-5 sm:gap-8">
        {
          posts.length > 0 ? (
            posts.map((post, index: number) => (
              <BlogCard
                id={post.id}
                title={post.title}
                excerpt={post.excerpt}
                author={post.author || "ReactifyAI Team"}
                date={formatDate(post._createdAt)}
                category={post.category || "Tech"}
                image={
                  post.mainImage
                    ? urlFor(post.mainImage).url()
                    : post.image
                      ? urlFor(post.image).url()
                      : "https://placehold.co/600x400?text=No+Image"
                }
                readTime={post.readTime || "5 min read"}
                index={index}
              />
            ))
          ) : (
            <div class="col-span-full text-center py-20 text-muted-foreground">
              <p>No blog posts found. Check back later!</p>
            </div>
          )
        }
      </div>
      <!-- End Blog Posts Grid -->
      <div class="text-center" data-aos="fade-up" data-aos-delay="600">
        <!-- View All Articles Button -->
        <a href="/blog">
          <Button variant="hero" size="lg" className="w-fit mx-auto"
            >View All Articles</Button
          >
        </a>
      </div>
    </div>
  </div>
  <NeuralLine />
</section>
<!-- End Blog Section -->
